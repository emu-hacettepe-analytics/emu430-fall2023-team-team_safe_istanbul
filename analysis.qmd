---
title: "Analysis - Team Safe Istanbul"

format:
  html:
    code-fold: true
    code-summary: "Show the code"
---

## Analysis of "Eartquake Analysis and Results Data"

```{r, message=FALSE}
    library(dplyr)
    library(readr)
    library(knitr)
    library(ggplot2)
    library(leaflet)
    library(patchwork)
    library(readxl)
    
    deprem_analiz <- read.csv("Deprem_senaryosu_analiz_sonuçlar.csv")
    deprem_analiz$ilce_adi <- gsub("Ý", "İ", deprem_analiz$ilce_adi, fixed = TRUE)
    deprem_analiz$ilce_adi <- gsub("Ð", "Ğ", deprem_analiz$ilce_adi, fixed = TRUE)
    deprem_analiz$ilce_adi <- gsub("Þ", "Ş", deprem_analiz$ilce_adi, fixed = TRUE)
    deprem_analiz$ilce_adi <- gsub("Þ", "Ş", deprem_analiz$ilce_adi, fixed = TRUE)
    
    deprem_analiz <- data.frame(lapply(deprem_analiz, function(v) {
      if (is.character(v)) return(tolower(v))
      else return(v)
    }))
    
    nufus <- read_excel("belediye_nufuslar_2019.xlsx")
    nufus <- data.frame(lapply(nufus, function(v) {
      if (is.character(v)) return(tolower(v))
      else return(v)
    }))
    nufus$Belediyeler <- gsub("belediyesi", "", nufus$Belediyeler)
   
    mahalle_bazli_bina <- read.csv("mahalle_bazli_bina_2017.csv")
colnames(mahalle_bazli_bina) <- c("id", "ilce_adi", "mahalle_adi", "mahalle_kodu", "once_1980", "ara_1980_2000", "sonra_2000", "ara_1_4_kat", "ara_5_9_kat", "ara_9_19_kat")
mahalle_bazli_bina$ilce_adi <- gsub("Ý", "İ", deprem_analiz$ilce_adi, fixed = TRUE)
mahalle_bazli_bina$ilce_adi <- gsub("Ð", "Ğ", deprem_analiz$ilce_adi, fixed = TRUE)
mahalle_bazli_bina$ilce_adi <- gsub("Þ", "Ş", deprem_analiz$ilce_adi, fixed = TRUE)
mahalle_bazli_bina$ilce_adi <- gsub("Þ", "Ş", deprem_analiz$ilce_adi, fixed = TRUE)

mahalle_bazli_bina$mahalle_adi <- gsub("Ý", "İ", deprem_analiz$ilce_adi, fixed = TRUE)
mahalle_bazli_bina$mahalle_adi <- gsub("Ð", "Ğ", deprem_analiz$ilce_adi, fixed = TRUE)
mahalle_bazli_bina$mahalle_adi <- gsub("Þ", "Ş", deprem_analiz$ilce_adi, fixed = TRUE)
mahalle_bazli_bina$mahalle_adi <- gsub("Þ", "Ş", deprem_analiz$ilce_adi, fixed = TRUE)    

toplam_bina <- mahalle_bazli_bina %>% 
  select(ara_1_4_kat,ara_5_9_kat,ara_9_19_kat) %>%
  rowwise() %>%
  do( (.) %>% as.data.frame() %>% mutate(toplam_bina = sum(.))) %>%
  ungroup %>%
  select(toplam_bina)
mahalle_bazli_bina <- cbind(mahalle_bazli_bina, toplam_bina)

bina_sayisi <- mahalle_bazli_bina %>% 
  group_by(ilce_adi) %>%
  summarize(ilce_bazli_bina = sum(toplam_bina)) #shows the total number of                                                        buildings within each district
bina_sayisi <- data.frame(bina_sayisi)


    
    istanbul_coordinates <- read.csv("istanbul_koordinatlar.csv")
    istanbul_coordinates <- data.frame(lapply(istanbul_coordinates, function(v) {
      if (is.character(v)) return(tolower(v))
      else return(v)
    }))    
    

    
    colnames(deprem_analiz)[1:4] <- c("id", "ilce_adi", "mahalle_adi", "mahalle_kodu")
    district_sum <- deprem_analiz %>% group_by(ilce_adi) %>% summarise(
                                                                  total_cok_agir_hasarli = sum(cok_agir_hasarli_bina_sayisi),
                                                                  total_agir_hasarli = sum(agir_hasarli_bina_sayisi),
                                                                  total_orta_hasarli = sum(orta_hasarli_bina_sayisi),
                                                                  total_hafif_hasarli = sum(hafif_hasarli_bina_sayisi),
                                                                  total_can_kaybi = sum(can_kaybi_sayisi),
                                                                  total_agir_yarali = sum(agir_yarali_sayisi),
                                                                  total_hafif_yarali = sum(hafif_yarali_sayisi),
                                                                  .groups = 'drop')
    
district_sum <- data.frame(district_sum)


    district_avg <- deprem_analiz %>% group_by(ilce_adi) %>% summarise(
                                                                  avg_cok_agir_hasarli = mean(cok_agir_hasarli_bina_sayisi),
                                                                  avg_agir_hasarli = mean(agir_hasarli_bina_sayisi),
                                                                  avg_orta_hasarli = mean(orta_hasarli_bina_sayisi),
                                                                  avg_hafif_hasarli = mean(hafif_hasarli_bina_sayisi),
                                                                  avg_can_kaybi = mean(can_kaybi_sayisi),
                                                                  avg_agir_yarali = mean(agir_yarali_sayisi),
                                                                  avg_hafif_yarali = mean(hafif_yarali_sayisi),
                                                                 .groups = 'drop')
    district_avg$ilce_adi <- factor(district_avg$ilce_adi, levels = unique(district_avg$ilce_adi))
    
    kable(head(district_avg, 10), caption="Data")
```

```{r}
istanbul_df <- full_join(district_sum, bina_sayisi, by = "ilce_adi")
populasyon <- inner_join(nufus, istanbul_coordinates, by = c("Belediyeler" = "ilceler"))
```

```{r, message=FALSE}
    building_avg_line <- ggplot(district_avg, aes(x = ilce_adi)) +
                geom_line(aes(y = avg_cok_agir_hasarli, group = 1, color = "Çok Ağır Hasarlı")) +
                geom_line(aes(y = avg_agir_hasarli, group = 1, color = "Ağır Hasarlı")) +
                geom_line(aes(y = avg_orta_hasarli, group = 1, color = "Orta Hasarlı")) +
                geom_line(aes(y = avg_hafif_hasarli, group = 1, color = "Hafif Hasarlı")) +
                ylab("Ortalama Bina Sayısı") +
                xlab("İlçe Adı") +
                ggtitle("Deprem Hasar Analizi İlçe Bazında Ortalamalar (Line Chart)") +
                theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
                scale_color_manual(values = c("Çok Ağır Hasarlı" = "red", "Ağır Hasarlı" = "orange", 
                                              "Orta Hasarlı" = "blue", "Hafif Hasarlı" = "black"))
  
    building_avg_bar <- ggplot(district_avg, aes(x = ilce_adi)) +
                geom_bar(aes(y = avg_hafif_hasarli), fill = "black", position = "dodge", stat = "identity") +
                geom_bar(aes(y = avg_orta_hasarli), fill = "blue", position = "dodge", stat = "identity") +
                geom_bar(aes(y = avg_agir_hasarli), fill = "orange", position = "dodge", stat = "identity") +
                geom_bar(aes(y = avg_cok_agir_hasarli), fill = "red", position = "dodge", stat = "identity") +
                ylab("Ortalama Bina Sayısı") +
                xlab("İlçe Adı") +
                ggtitle("Deprem Hasar Analizi İlçe Bazında Ortalamalar")+
                theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

    avg_health <- ggplot(district_avg, aes(x = ilce_adi)) +
                geom_line(aes(y = avg_can_kaybi, group = 1, color = "Can Kaybı")) +
                geom_line(aes(y = avg_agir_yarali, group = 1, color = "Ağır Yaralı")) +
                geom_line(aes(y = avg_hafif_yarali, group = 1, color = "Hafif Yaralı")) +
                ylab("Yaralanma ve Can Kaybi") +
                xlab("İlçe Adı") +
                ggtitle("Deprem Hasar Analizi İlçe Bazında Ortalamalar (Line Chart)") +
                theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
                scale_color_manual(values = c("Can Kaybı" = "black", "Ağır Yaralı" = "red", 
                                              "Hafif Yaralı" = "blue"))
    
    

```

### average health

```{r, message=FALSE}
avg_health
```

### average building

```{r, message=FALSE}
  building_avg_bar
```

### average building line

```{r, message=FALSE}
  building_avg_line
```

### danger zone calc

```{r, message=FALSE}
    danger_level <- as.numeric(district_sum$total_cok_agir_hasarli * district_avg$avg_can_kaybi)
    istanbul_coordinates$danger_level <- as.numeric(format(danger_level, scientific = FALSE))
    istanbul_coordinates <- istanbul_coordinates[order(istanbul_coordinates$danger_level, decreasing = TRUE),]
    
    istanbul_coordinates$color <- ifelse(istanbul_coordinates$danger_level > mean(istanbul_coordinates$danger_level), "red", "blue")
    istanbul_coordinates$danger_level <- format(istanbul_coordinates$danger_level, scientific = FALSE)
    
    kable(head(istanbul_coordinates, 10), caption = "istanbul something.")

```

### danger zone map

```{r, message=FALSE}

    harita <- leaflet(istanbul_coordinates) %>%
      addTiles() %>%
      addCircleMarkers(
        lng = ~longitude,
        lat = ~latitude,
        radius = 10,
        color = ~color,
        fillOpacity = 0.5,
        popup = ~paste(ilceler, ": ", danger_level)
      )

    harita
```
